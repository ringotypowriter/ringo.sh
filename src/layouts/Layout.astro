---
import "../styles/global.css";
import { Github, Mail, Sun, Moon, MoreHorizontal, X } from "lucide-astro";
import SnowToggle from "../components/SnowToggle";
import Snowfall from "../components/Snowfall";

interface Props {
    title?: string;
    description?: string;
    canonicalPath?: string;
    ogType?: "website" | "article";
    ogImage?: string;
    noindex?: boolean;
    publishedTime?: Date | string;
    modifiedTime?: Date | string;
    jsonLd?: Record<string, unknown> | Array<Record<string, unknown>>;
}

const {
    title = "ringo.sh",
    description = "RingoTypowriter's Personal Site",
    canonicalPath,
    ogType = "website",
    ogImage = "/avatar_me.jpg",
    noindex = false,
    publishedTime,
    modifiedTime,
    jsonLd,
} = Astro.props;

const site = Astro.site ?? new URL("https://ringo.sh");
const canonicalUrl = new URL(canonicalPath ?? Astro.url.pathname, site);

function toAbsoluteUrl(input: string): string {
    try {
        return new URL(input).toString();
    } catch {
        return new URL(input, site).toString();
    }
}

function toIsoDateTime(value: Date | string | undefined): string | undefined {
    if (!value) return undefined;
    const date = typeof value === "string" ? new Date(value) : value;
    if (Number.isNaN(date.valueOf())) return undefined;
    return date.toISOString();
}

const ogImageUrl = toAbsoluteUrl(ogImage);
const publishedTimeIso = toIsoDateTime(publishedTime);
const modifiedTimeIso = toIsoDateTime(modifiedTime);

const defaultJsonLd = noindex
    ? undefined
    : {
          "@context": "https://schema.org",
          "@graph": [
              {
                  "@type": "WebSite",
                  name: "ringo.sh",
                  url: site.toString(),
              },
              {
                  "@type": "Person",
                  name: "Ringotypowriter",
                  url: site.toString(),
              },
          ],
      };

function toSafeJsonForHtml(value: unknown): string | undefined {
    const text = JSON.stringify(value, null, 0);
    if (!text) return undefined;
    return text
        .replaceAll("<", "\\u003c")
        .replaceAll(">", "\\u003e")
        .replaceAll("&", "\\u0026");
}

const jsonLdText = (jsonLd ?? defaultJsonLd)
    ? toSafeJsonForHtml(jsonLd ?? defaultJsonLd)
    : undefined;
---

<!doctype html>
<html lang="en" class="">
    <head>
        <script is:inline>
            // Theme initialization - runs immediately to prevent flash
            (function() {
                const stored = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const isDark = stored === 'dark' || (!stored && prefersDark);
                document.documentElement.classList.toggle('dark', isDark);
            })();
        </script>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/png" href="/favicon.png" />
        <meta name="generator" content={Astro.generator} />
        <meta name="description" content={description} />
        <meta name="referrer" content="strict-origin-when-cross-origin" />
        <meta name="color-scheme" content="light dark" />
        <meta
            name="robots"
            content={
                noindex
                    ? "noindex,nofollow"
                    : "index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1"
            }
        />
        <title>{title}</title>

        <link rel="canonical" href={canonicalUrl.toString()} />

        <meta property="og:site_name" content="ringo.sh" />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:type" content={ogType} />
        <meta property="og:url" content={canonicalUrl.toString()} />
        <meta property="og:image" content={ogImageUrl} />
        {publishedTimeIso && (
            <meta property="article:published_time" content={publishedTimeIso} />
        )}
        {modifiedTimeIso && (
            <meta property="article:modified_time" content={modifiedTimeIso} />
        )}

        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content={title} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={ogImageUrl} />
        <meta name="twitter:site" content="@ringoo95" />

        <link
            rel="alternate"
            type="application/rss+xml"
            title="ringo.sh RSS"
            href="/rss.xml"
        />

        {jsonLdText && (
            <script type="application/ld+json">{jsonLdText}</script>
        )}

        <!-- Google Fonts Import: Google Sans Code (Priority), Space Mono (Fallback), Noto Sans SC -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Google+Sans+Code:wght@400;500;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
            rel="stylesheet"
        />
    </head>
    <body
        class="max-w-3xl mx-auto px-6 py-12 md:py-20 flex flex-col min-h-screen"
    >
        <!-- Snowfall Effect -->
        <Snowfall client:load />

        <header class="mb-12 flex justify-between items-center relative">
            <a
                href="/"
                class="flex items-center gap-2 hover:no-underline group"
            >
                <img
                    src="/avatar_me.jpg"
                    alt="Avatar"
                    class="w-10 h-10 rounded-full transition-all duration-500 border border-sand-text-light/20 dark:border-sand-text-dark/20"
                />
                <span class="text-xl font-mono font-bold hidden sm:inline">ringo.sh</span>
            </a>

            <!-- Desktop Navigation -->
            <nav
                class="hidden sm:flex items-center gap-6 text-sm font-mono text-sand-text-light/80 dark:text-sand-text-dark/80"
            >
                <a href="/snippets">Snippets</a>
                <a href="/projects">Projects</a>
                <a href="/playground">Playground</a>
                <SnowToggle client:load />
                <button
                    id="theme-toggle"
                    class="p-1.5 rounded-md hover:bg-sand-text-light/10 dark:hover:bg-sand-text-dark/10 transition-colors"
                    aria-label="Toggle theme"
                >
                    <Sun size={16} class="hidden dark:block" />
                    <Moon size={16} class="block dark:hidden" />
                </button>
            </nav>

            <!-- Mobile Menu Button -->
            <button
                id="mobile-menu-toggle"
                class="sm:hidden p-1.5 rounded-md hover:bg-sand-text-light/10 dark:hover:bg-sand-text-dark/10 transition-colors"
                aria-label="Toggle menu"
            >
                <MoreHorizontal size={20} class="dark:text-sand-text-dark" />
            </button>

            <!-- Mobile Navigation Menu -->
            <div
                id="mobile-menu"
                class="hidden sm:hidden absolute top-full right-0 mt-2 w-36 bg-sand-light dark:bg-sand-dark border border-sand-text-light/20 dark:border-sand-text-dark/20 rounded-lg shadow-lg py-1 z-50"
            >
                <a href="/snippets" class="block py-1.5 px-3 font-mono text-xs hover:bg-sand-text-light/10 dark:hover:bg-sand-text-dark/10">Snippets</a>
                <a href="/projects" class="block py-1.5 px-3 font-mono text-xs hover:bg-sand-text-light/10 dark:hover:bg-sand-text-dark/10">Projects</a>
                <a href="/playground" class="block py-1.5 px-3 font-mono text-xs hover:bg-sand-text-light/10 dark:hover:bg-sand-text-dark/10">Playground</a>
                <div class="my-1 border-t border-sand-text-light/10 dark:border-sand-text-dark/10"></div>
                <button id="mobile-snow-toggle" class="flex items-center gap-2 px-3 py-1.5 hover:bg-sand-text-light/10 dark:hover:bg-sand-text-dark/10 rounded w-full">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 12h20M12 2v20M4.93 4.93l14.14 14.14M19.07 4.93L4.93 19.07" />
                        <circle cx="12" cy="12" r="4" />
                    </svg>
                    <span class="font-mono text-xs">Snow</span>
                </button>
                <button id="mobile-theme-toggle" class="flex w-full text-left px-3 py-1.5 items-center gap-2 hover:bg-sand-text-light/10 dark:hover:bg-sand-text-dark/10">
                    <Sun size={16} class="hidden dark:block" />
                    <Moon size={16} class="block dark:hidden" />
                    <span class="font-mono text-xs">Theme</span>
                </button>
            </div>
        </header>

        <main class="grow">
            <slot />
        </main>

        <footer
            class="mt-20 pt-8 border-t border-sand-text-light/10 dark:border-sand-text-dark/10 flex justify-between items-center text-xs font-mono opacity-60"
        >
            <div>
                <span>&copy; {new Date().getFullYear()} Ringotypowriter</span>
                <span class="mx-2">::</span>
                <span>PL Protocol // Online</span>
            </div>
            <div class="flex gap-4">
                <a
                    href="https://github.com/ringotypowriter"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="hover:opacity-100 transition-opacity"
                    aria-label="GitHub"
                >
                    <Github size={16} />
                </a>
                <a
                    href="https://x.com/ringoo95"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="hover:opacity-100 transition-opacity flex items-center"
                    aria-label="X"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5 text-sand-text-light dark:text-white" fill="currentColor">
                        <path d="M321.8 373.1h36.6L190 137.5H153.4ZM391 389.9H310.6L237 285.1 144.8 389.9H121L226.4 270 121 120h80.4l69.7 99.2L358.4 120h23.8L281.7 234.3Z" />
                    </svg>
                </a>
                <a
                    href="mailto:connect@ringo.sh"
                    class="hover:opacity-100 transition-opacity"
                    aria-label="Email"
                >
                    <Mail size={16} />
                </a>
            </div>
        </footer>

        <script>
            // Theme toggle
            const toggle = document.getElementById('theme-toggle');
            const mobileThemeToggle = document.getElementById('mobile-theme-toggle');
            const toggleTheme = () => {
                const wasDark = document.documentElement.classList.contains('dark');
                const isDark = !wasDark;
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                window.dispatchEvent(new CustomEvent('theme-change', { detail: { isDark } }));
                updateThemeIcons();

                // When switching to light mode, turn off snow
                if (!isDark) {
                    localStorage.setItem('snow-toggle', 'false');
                    window.dispatchEvent(new CustomEvent('snow-toggle', { detail: { active: false } }));
                    updateSnowIcon();
                }
            };
            toggle?.addEventListener('click', toggleTheme);
            mobileThemeToggle?.addEventListener('click', toggleTheme);

            function updateThemeIcons() {
                const isDark = document.documentElement.classList.contains('dark');
                [toggle, mobileThemeToggle].forEach(btn => {
                    if (!btn) return;
                    const svgs = btn.querySelectorAll('svg');
                    if (svgs[0]) svgs[0].classList.toggle('hidden', isDark);
                    if (svgs[1]) svgs[1].classList.toggle('hidden', !isDark);
                });
            }
            updateThemeIcons();

            // Update mobile snow style to match SnowToggle state
            function updateSnowIcon() {
                const saved = localStorage.getItem("snow-toggle");
                let isActive = saved === "true";
                if (saved === null) {
                    const now = new Date();
                    isActive = now.getMonth() >= 11 || now.getMonth() <= 1;
                }
                const mobileSnowBtn = document.getElementById('mobile-snow-toggle');
                if (mobileSnowBtn) {
                    const svg = mobileSnowBtn.querySelector('svg');
                    const span = mobileSnowBtn.querySelector('span');
                    // Only dim in dark theme when off
                    if (svg) {
                        const isDark = document.documentElement.classList.contains('dark');
                        svg.style.opacity = isActive ? '1' : (isDark ? '0.4' : '1');
                    }
                    if (span) {
                        const isDark = document.documentElement.classList.contains('dark');
                        span.style.opacity = isActive ? '1' : (isDark ? '0.4' : '1');
                    }
                }
            }
            updateSnowIcon();
            window.addEventListener('snow-toggle', updateSnowIcon);

            // Mobile menu toggle
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenuToggle?.addEventListener('click', (e) => {
                e.stopPropagation();
                mobileMenu?.classList.toggle('hidden');
            });

            // Mobile snow toggle click
            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target instanceof Element && target.closest('#mobile-snow-toggle')) {
                    const saved = localStorage.getItem("snow-toggle");
                    let isActive = saved === "true";
                    if (saved === null) {
                        const now = new Date();
                        isActive = now.getMonth() >= 11 || now.getMonth() <= 1;
                    }
                    const newState = !isActive;
                    localStorage.setItem("snow-toggle", String(newState));
                    window.dispatchEvent(new CustomEvent('snow-toggle', { detail: { active: newState } }));
                }
            });

            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                const target = e.target instanceof Node ? e.target : null;
                if (!mobileMenu?.contains(target) && !mobileMenuToggle?.contains(target)) {
                    mobileMenu?.classList.add('hidden');
                }
            });

            // Close menu when clicking a link
            mobileMenu?.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => mobileMenu?.classList.add('hidden'));
            });
        </script>
    </body>
</html>
