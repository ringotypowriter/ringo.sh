---
import "../styles/global.css";
import { Github, X, Mail, Sun, Moon } from "lucide-astro";
import SnowToggle from "../components/SnowToggle";
import Snowfall from "../components/Snowfall";

interface Props {
    title?: string;
    description?: string;
    canonicalPath?: string;
    ogType?: "website" | "article";
    ogImage?: string;
    noindex?: boolean;
    publishedTime?: Date | string;
    modifiedTime?: Date | string;
    jsonLd?: Record<string, unknown> | Array<Record<string, unknown>>;
}

const {
    title = "ringo.sh",
    description = "RingoTypowriter's Personal Site",
    canonicalPath,
    ogType = "website",
    ogImage = "/avatar_me.jpg",
    noindex = false,
    publishedTime,
    modifiedTime,
    jsonLd,
} = Astro.props;

const site = Astro.site ?? new URL("https://ringo.sh");
const canonicalUrl = new URL(canonicalPath ?? Astro.url.pathname, site);

function toAbsoluteUrl(input: string): string {
    try {
        return new URL(input).toString();
    } catch {
        return new URL(input, site).toString();
    }
}

function toIsoDateTime(value: Date | string | undefined): string | undefined {
    if (!value) return undefined;
    const date = typeof value === "string" ? new Date(value) : value;
    if (Number.isNaN(date.valueOf())) return undefined;
    return date.toISOString();
}

const ogImageUrl = toAbsoluteUrl(ogImage);
const publishedTimeIso = toIsoDateTime(publishedTime);
const modifiedTimeIso = toIsoDateTime(modifiedTime);

const defaultJsonLd = noindex
    ? undefined
    : {
          "@context": "https://schema.org",
          "@graph": [
              {
                  "@type": "WebSite",
                  name: "ringo.sh",
                  url: site.toString(),
              },
              {
                  "@type": "Person",
                  name: "Ringotypowriter",
                  url: site.toString(),
              },
          ],
      };

function toSafeJsonForHtml(value: unknown): string | undefined {
    const text = JSON.stringify(value, null, 0);
    if (!text) return undefined;
    return text
        .replaceAll("<", "\\u003c")
        .replaceAll(">", "\\u003e")
        .replaceAll("&", "\\u0026");
}

const jsonLdText = (jsonLd ?? defaultJsonLd)
    ? toSafeJsonForHtml(jsonLd ?? defaultJsonLd)
    : undefined;
---

<!doctype html>
<html lang="en" class="">
    <head>
        <script is:inline>
            // Theme initialization - runs immediately to prevent flash
            (function() {
                const stored = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const isDark = stored === 'dark' || (!stored && prefersDark);
                document.documentElement.classList.toggle('dark', isDark);
            })();
        </script>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/png" href="/favicon.png" />
        <meta name="generator" content={Astro.generator} />
        <meta name="description" content={description} />
        <meta name="referrer" content="strict-origin-when-cross-origin" />
        <meta name="color-scheme" content="light dark" />
        <meta
            name="robots"
            content={
                noindex
                    ? "noindex,nofollow"
                    : "index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1"
            }
        />
        <title>{title}</title>

        <link rel="canonical" href={canonicalUrl.toString()} />

        <meta property="og:site_name" content="ringo.sh" />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:type" content={ogType} />
        <meta property="og:url" content={canonicalUrl.toString()} />
        <meta property="og:image" content={ogImageUrl} />
        {publishedTimeIso && (
            <meta property="article:published_time" content={publishedTimeIso} />
        )}
        {modifiedTimeIso && (
            <meta property="article:modified_time" content={modifiedTimeIso} />
        )}

        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content={title} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={ogImageUrl} />
        <meta name="twitter:site" content="@ringoo95" />

        <link
            rel="alternate"
            type="application/rss+xml"
            title="ringo.sh RSS"
            href="/rss.xml"
        />

        {jsonLdText && (
            <script type="application/ld+json">{jsonLdText}</script>
        )}

        <!-- Google Fonts Import: Google Sans Code (Priority), Space Mono (Fallback), Noto Sans SC -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Google+Sans+Code:wght@400;500;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
            rel="stylesheet"
        />
    </head>
    <body
        class="max-w-3xl mx-auto px-6 py-12 md:py-20 flex flex-col min-h-screen"
    >
        <!-- Snowfall Effect -->
        <Snowfall client:load />

        <header class="mb-12 flex justify-between items-center">
            <a
                href="/"
                class="flex items-center gap-2 hover:no-underline group"
            >
                <img
                    src="/avatar_me.jpg"
                    alt="Avatar"
                    class="w-10 h-10 rounded-full transition-all duration-500 border border-sand-text-light/20 dark:border-sand-text-dark/20"
                />
                <span class="text-xl font-mono font-bold hidden sm:inline">ringo.sh</span>
            </a>
            <nav
                class="flex items-center gap-4 sm:gap-6 text-sm font-mono text-sand-text-light/80 dark:text-sand-text-dark/80"
            >
                <a href="/snippets">Snippets</a>
                <a href="/projects">Projects</a>
                <SnowToggle client:load />
                <button
                    id="theme-toggle"
                    class="p-1.5 rounded-md hover:bg-sand-text-light/10 dark:hover:bg-sand-text-dark/10 transition-colors"
                    aria-label="Toggle theme"
                >
                    <Sun size={16} class="hidden dark:block" />
                    <Moon size={16} class="block dark:hidden" />
                </button>
            </nav>
        </header>

        <main class="flex-grow">
            <slot />
        </main>

        <footer
            class="mt-20 pt-8 border-t border-sand-text-light/10 dark:border-sand-text-dark/10 flex justify-between items-center text-xs font-mono opacity-60"
        >
            <div>
                <span>&copy; {new Date().getFullYear()} Ringotypowriter</span>
                <span class="mx-2">::</span>
                <span>PL Protocol // Online</span>
            </div>
            <div class="flex gap-4">
                <a
                    href="https://github.com/ringotypowriter"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="hover:opacity-100 transition-opacity"
                    aria-label="GitHub"
                >
                    <Github size={16} />
                </a>
                <a
                    href="https://x.com/ringoo95"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="hover:opacity-100 transition-opacity"
                    aria-label="X"
                >
                    <X size={16} />
                </a>
                <a
                    href="mailto:connect@ringo.sh"
                    class="hover:opacity-100 transition-opacity"
                    aria-label="Email"
                >
                    <Mail size={16} />
                </a>
            </div>
        </footer>

        <script>
            // Theme toggle functionality
            const toggle = document.getElementById('theme-toggle');
            toggle?.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                // Dispatch event for components that need to react to theme changes
                window.dispatchEvent(new CustomEvent('theme-change', { detail: { isDark } }));
            });
        </script>
    </body>
</html>
