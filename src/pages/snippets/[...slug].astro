---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";

export async function getStaticPaths() {
    const allEntries = await getCollection("snippets");
    const publishedEntries = allEntries.filter(entry => !entry.data.wip);
    console.log(
        "üìù Entries:",
        publishedEntries.map((e) => ({ id: e.id, slug: (e as any).slug })),
    );
    return publishedEntries.map((entry) => ({
        params: { slug: entry.id },
        props: { entry },
    }));
}

interface Props {
    entry: CollectionEntry<"snippets">;
}

const { entry } = Astro.props;

// Format date (fallback for SSR)
const formattedDate = entry.data.date.toISOString().split("T")[0];

const site = Astro.site ?? new URL("https://ringo.sh");
const canonicalPath = `/snippets/${entry.id}`;
const canonicalUrl = new URL(canonicalPath, site).toString();

const jsonLd = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: entry.data.title,
    description: entry.data.description ?? "",
    datePublished: entry.data.date.toISOString(),
    dateModified: entry.data.date.toISOString(),
    author: {
        "@type": "Person",
        name: "Ringotypowriter",
        url: site.toString(),
    },
    mainEntityOfPage: {
        "@type": "WebPage",
        "@id": canonicalUrl,
    },
    url: canonicalUrl,
    image: new URL("/avatar_me.jpg", site).toString(),
};
---

<Layout
    title={`${entry.data.title} | ringo.sh`}
    description={entry.data.description}
    canonicalPath={canonicalPath}
    ogType="article"
    publishedTime={entry.data.date}
    modifiedTime={entry.data.date}
    jsonLd={jsonLd}
>
    <article class="prose prose-sand max-w-none">
        <h1 class="font-mono text-2xl mb-2">{entry.data.title}</h1>
        <div class="font-mono text-xs opacity-50 mb-12 dashed-bottom pb-4">
            <time data-time={entry.data.date.toISOString()}>
                {formattedDate}
            </time> :: SYSTEM_LOG
        </div>

        <div set:html={entry.rendered?.html} />
    </article>

    <div class="mt-20">
        <a
            href="/snippets"
            class="font-mono text-sm opacity-60 hover:opacity-100"
            >&lt;- Back to Index</a
        >
    </div>
</Layout>

<script>
    import { initTimeElements } from '../../lib/formatTime';
    
    // È°µÈù¢Âä†ËΩΩÊó∂ËΩ¨Êç¢ÊâÄÊúâÊó∂Èó¥‰∏∫Êú¨Âú∞Êó∂Èó¥
    initTimeElements();
</script>

<style>
    .dashed-bottom {
        border-bottom: 1px dashed currentColor;
    }
</style>
